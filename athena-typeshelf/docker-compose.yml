version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: athena-typeshelf_server_1
      APP_PORT: 5000

  server:
    image: ghcr.io/azoora/typeshelf:0.1.0
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000

      # Postgres connection (Umbrel provides APP_PASSWORD)
      DATABASE_URL: postgres://postgres:${APP_PASSWORD}@db:5432/typeshelf

      # Optional, if your app uses sessions
      SESSION_SECRET: ${APP_PASSWORD}

    # Ensure DB tables exist before starting
    command: sh -c "npm run db:push && node dist/index.cjs"

    volumes:
      - ${APP_DATA_DIR}/fonts:/app/fonts

    depends_on:
      - db

  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: typeshelf
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${APP_PASSWORD}
    volumes:
      - ${APP_DATA_DIR}/postgres:/var/lib/postgresql/data
